#!/usr/bin/env bash

function keys() {
	local config="${HOME}/.config/kmonad/config.env.kbd"

	if [[ ! -f ${config} ]]; then
		keys-legacy
	fi

	# run for all relevant keyboard devices
	local keyboards="$(hwinfo --keyboard | grep -oE '/dev/input/by-path/[0-9A-Za-z_\-]+')"
	for keyboard in $keyboards; do
		echo "keyboard: ${keyboard}"
		export KEYBOARD="${keyboard}"
		# TODO: I bet this hangs and wouldn't actually work for multiple keyboards. A problem for the distant future!
		envsubst <${config} | ~/local/bin/kmonad /dev/stdin
	done
}

keys "$@"
